<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registration Tally - SNEHA SAURABHA 2025-26</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #D4AF37 0%, #F4D03F 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #D4AF37;
            gap: 20px;
        }
        
        .header-logo {
            width: 100px;
            height: 100px;
            object-fit: contain;
            flex-shrink: 0;
        }
        
        .header-center {
            flex: 1;
            text-align: center;
        }
        
        header h1 {
            color: #D4AF37;
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        header p {
            color: #666;
            font-size: 16px;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .search-box {
            flex: 1;
            max-width: 400px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #D4AF37;
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }
        
        .stat-item {
            font-size: 14px;
            color: #666;
        }
        
        .stat-item strong {
            color: #D4AF37;
            font-size: 18px;
            margin-right: 5px;
        }
        
        .export-btn {
            background: #22C55E;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .export-btn:hover {
            background: #16A34A;
            transform: translateY(-2px);
        }
        
        .table-wrapper {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #E5E7EB;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        thead {
            background: #F9FAFB;
            position: sticky;
            top: 0;
        }
        
        th {
            padding: 14px 12px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #E5E7EB;
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        
        th:hover {
            background: #F3F4F6;
        }
        
        th.sortable::after {
            content: ' ‚áÖ';
            color: #9CA3AF;
            font-size: 12px;
        }
        
        th.sorted-asc::after {
            content: ' ‚Üë';
            color: #D4AF37;
        }
        
        th.sorted-desc::after {
            content: ' ‚Üì';
            color: #D4AF37;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #F3F4F6;
            color: #4B5563;
        }
        
        tbody tr:hover {
            background: #F9FAFB;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-paid {
            background: #D1FAE5;
            color: #065F46;
        }
        
        .status-pending {
            background: #FEF3C7;
            color: #92400E;
        }
        
        .meal-veg {
            color: #16A34A;
            font-weight: 600;
        }
        
        .meal-non-veg {
            color: #DC2626;
            font-weight: 600;
        }
        
        .meal-jain {
            color: #D97706;
            font-weight: 600;
        }
        
        .loading {
            text-align: center;
            padding: 60px;
            color: #9CA3AF;
        }
        
        .error {
            text-align: center;
            padding: 60px;
            color: #DC2626;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            header {
                flex-direction: column;
                gap: 15px;
            }
            
            .header-logo {
                width: 80px;
                height: 80px;
            }
            
            header h1 {
                font-size: 24px;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 8px 6px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <img src="../images/header-left.jpg" alt="Left Logo" class="header-logo">
            <div class="header-center">
                <h1>üìä Registration Tally</h1>
                <p>SNEHA SAURABHA 2025-26 - District Conference</p>
            </div>
            <img src="../images/header-right.jpg" alt="Right Logo" class="header-logo">
        </header>
        
        <div class="controls">
            <div class="search-box">
                <input type="text" id="search-input" placeholder="üîç Search by name, mobile, email, club..." onkeyup="searchTable()">
            </div>
            <div class="stat-item">
                <strong id="total-count">0</strong> Total Registrations
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="export-btn" onclick="exportToExcel()">üì• Download All</button>
                <select id="zone-select" class="export-btn" style="padding: 12px 16px; cursor: pointer;">
                    <option value="">üìç Zone-Wise Download</option>
                </select>
            </div>
        </div>
        
        <div class="table-wrapper">
            <table id="registrations-table">
                <thead>
                    <tr>
                        <th class="sortable" onclick="sortTable(0)" data-column="registration_id">ID</th>
                        <th class="sortable" onclick="sortTable(1)" data-column="created_at">Date</th>
                        <th class="sortable" onclick="sortTable(2)" data-column="name">Name</th>
                        <th class="sortable" onclick="sortTable(3)" data-column="mobile">Mobile</th>
                        <th class="sortable" onclick="sortTable(4)" data-column="email">Email</th>
                        <th class="sortable" onclick="sortTable(5)" data-column="registration_type">Type</th>
                        <th class="sortable" onclick="sortTable(6)" data-column="club">Club</th>
                        <th class="sortable" onclick="sortTable(7)" data-column="meal_preference">Meal</th>
                        <th class="sortable" onclick="sortTable(8)" data-column="tshirt_size">T-Shirt</th>
                        <th class="sortable" onclick="sortTable(9)" data-column="registration_amount">Amount</th>
                        <th class="sortable" onclick="sortTable(10)" data-column="payment_status">Status</th>
                    </tr>
                </thead>
                <tbody id="registrations-body">
                    <tr>
                        <td colspan="11" class="loading">Loading registrations...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let allRegistrations = [];
        let filteredRegistrations = [];
        let currentSort = { column: null, direction: 'asc' };
        
        // Zone mapping for clubs
        const zoneMapping = {
            'Zone 1 - Mysore City': ['Mysore', 'Central Mysore', 'Mysore Midtown', 'Mysore Metro', 'Mysore North', 'Mysore East', 'Mysore West', 'Mysore SouthEast', 'Mysore Ambari', 'Mysore Royal', 'Mysore Brindavan', 'Mysore Elite', 'Mysore Jayaprakash Nagar', 'Mysore Sreegandha', 'Mysore Stars', 'Mysuru Diamond', 'Heritage Mysuru', 'Vijayanagara Mysore', 'Krishnaraja', 'E Club of Mysore Center', 'Ivory City', 'Panchasheel'],
            'Zone 2 - Mysore District': ['H D Kote', 'Hunsur', 'Krishnarajanagara', 'Nanjangud', 'Periyapatna Midtown', 'Periyapatna Icons', 'Siddakatte', 'Bannur', 'Shanivarashanthe'],
            'Zone 3 - Chamarajanagar': ['Chamarajanagara', 'Chamarajanagara Silk City', 'Kollegala', 'Kollegala Midtown', 'Yelandur Greenway'],
            'Zone 4 - Kodagu': ['Madikeri', 'Misty Hills Madikeri', 'Gonikoppal', 'Virajpete', 'Kushalnagara', 'Somarpete Hills', 'Hemavathi Kodlipete'],
            'Zone 5 - Mangalore City': ['Mangalore', 'Mangalore Central', 'Mangalore City', 'Mangalore Coastal', 'Mangalore Down Town', 'Mangalore East', 'Mangalore Hillside', 'Mangalore Metro', 'Mangalore Midtown', 'Mangalore North', 'Mangalore Port Town', 'Mangalore Seaside', 'Mangalore South', 'Mangalore Sunrise'],
            'Zone 6 - DK District': ['Bantwal', 'Bantwal Town', 'Bantwal Loretto Hills', 'Belthangady', 'B C Road City', 'Baikampady', 'Deralakatte', 'Moodabidri', 'Moodabidri Temple Town', 'Mulki', 'Surathkal', 'Puttur', 'Puttur Central', 'Puttur City', 'Puttur East', 'Puttur Elite', 'Puttur Swarna', 'Puttur Yuva', 'Birumale Hills Puttur', 'Sullia', 'Sullia City', 'Uppinangdi', 'Subramanya', 'Vittal', 'Modankap', 'Madhyanthar']
        };
        
        // Fetch registrations on page load
        document.addEventListener('DOMContentLoaded', function() {
            fetchRegistrations();
        });
        
        async function fetchRegistrations() {
            try {
                // Use the correct serverless function endpoint
                const response = await fetch('/api/registrations/list');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('API Response:', data);
                
                // API returns {success: true, data: {registrations: [...], total: ...}}
                if (data.success && data.data && data.data.registrations) {
                    allRegistrations = data.data.registrations || [];
                    filteredRegistrations = [...allRegistrations];
                    displayRegistrations(filteredRegistrations);
                    updateStats(filteredRegistrations);
                    populateZoneDropdown();
                } else if (data.success && data.registrations) {
                    // Fallback if structure is different
                    allRegistrations = data.registrations || [];
                    filteredRegistrations = [...allRegistrations];
                    displayRegistrations(filteredRegistrations);
                    updateStats(filteredRegistrations);
                    populateZoneDropdown();
                } else {
                    showError('No registrations found');
                }
            } catch (error) {
                console.error('Error fetching registrations:', error);
                showError('Error loading data: ' + error.message);
            }
        }
        
        function populateZoneDropdown() {
            const select = document.getElementById('zone-select');
            select.innerHTML = '<option value="">üìç Zone-Wise Download</option>';
            
            Object.keys(zoneMapping).forEach(zone => {
                const option = document.createElement('option');
                option.value = zone;
                option.textContent = zone;
                select.appendChild(option);
            });
            
            select.onchange = function() {
                if (this.value) {
                    exportZoneWise(this.value);
                    this.value = ''; // Reset selection
                }
            };
        }
        
        function getZoneForClub(club) {
            for (const [zone, clubs] of Object.entries(zoneMapping)) {
                if (clubs.includes(club)) {
                    return zone;
                }
            }
            return 'Unassigned';
        }
        
        function searchTable() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            if (searchTerm === '') {
                filteredRegistrations = [...allRegistrations];
            } else {
                filteredRegistrations = allRegistrations.filter(reg => {
                    return (
                        (reg.name || '').toLowerCase().includes(searchTerm) ||
                        (reg.mobile || '').toLowerCase().includes(searchTerm) ||
                        (reg.email || '').toLowerCase().includes(searchTerm) ||
                        (reg.club || '').toLowerCase().includes(searchTerm) ||
                        (reg.registration_id || '').toLowerCase().includes(searchTerm) ||
                        (reg.registration_type || '').toLowerCase().includes(searchTerm)
                    );
                });
            }
            
            displayRegistrations(filteredRegistrations);
            updateStats(filteredRegistrations);
        }
        
        function sortTable(columnIndex) {
            const headers = document.querySelectorAll('th.sortable');
            const column = headers[columnIndex].getAttribute('data-column');
            
            // Toggle sort direction
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            
            // Remove all sort classes
            headers.forEach(h => {
                h.classList.remove('sorted-asc', 'sorted-desc');
            });
            
            // Add sort class to current header
            headers[columnIndex].classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
            
            // Sort the data
            filteredRegistrations.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];
                
                // Handle null/undefined
                if (aVal === null || aVal === undefined) aVal = '';
                if (bVal === null || bVal === undefined) bVal = '';
                
                // Handle numbers (amount)
                if (column === 'registration_amount') {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                } 
                // Handle dates
                else if (column === 'created_at') {
                    aVal = new Date(aVal).getTime();
                    bVal = new Date(bVal).getTime();
                }
                // Handle strings
                else {
                    aVal = String(aVal).toLowerCase();
                    bVal = String(bVal).toLowerCase();
                }
                
                if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });
            
            displayRegistrations(filteredRegistrations);
        }
        
        function displayRegistrations(registrations) {
            const tbody = document.getElementById('registrations-body');
            
            if (registrations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 40px; color: #9CA3AF;">No registrations found</td></tr>';
                return;
            }
            
            tbody.innerHTML = registrations.map(reg => {
                const date = new Date(reg.created_at).toLocaleDateString('en-IN');
                const mealClass = reg.meal_preference === 'Veg' ? 'meal-veg' : 
                                 reg.meal_preference === 'Non-Veg' ? 'meal-non-veg' : 'meal-jain';
                const statusClass = reg.payment_status === 'paid' ? 'status-paid' : 'status-pending';
                
                return `
                    <tr>
                        <td>${reg.registration_id}</td>
                        <td>${date}</td>
                        <td>${reg.name}</td>
                        <td>${reg.mobile}</td>
                        <td>${reg.email || 'N/A'}</td>
                        <td>${reg.registration_type}</td>
                        <td>${reg.club || 'N/A'}</td>
                        <td class="${mealClass}">${reg.meal_preference}</td>
                        <td>${reg.tshirt_size || 'N/A'}</td>
                        <td>‚Çπ${(reg.registration_amount || 0).toLocaleString('en-IN')}</td>
                        <td><span class="status-badge ${statusClass}">${reg.payment_status || 'pending'}</span></td>
                    </tr>
                `;
            }).join('');
        }
        
        function updateStats(registrations) {
            const totalCount = registrations.length;
            document.getElementById('total-count').textContent = totalCount;
        }
        
        function showError(message) {
            const tbody = document.getElementById('registrations-body');
            tbody.innerHTML = `<tr><td colspan="11" class="error">${message}</td></tr>`;
        }
        
        function exportToExcel() {
            if (allRegistrations.length === 0) {
                alert('No data to export');
                return;
            }
            
            // Prepare data for Excel
            const excelData = allRegistrations.map(reg => ({
                'Registration ID': reg.registration_id,
                'Date': new Date(reg.created_at).toLocaleDateString('en-IN'),
                'Name': reg.name,
                'Mobile': reg.mobile,
                'Email': reg.email || 'N/A',
                'Type': reg.registration_type,
                'Club': reg.club || 'N/A',
                'Zone': getZoneForClub(reg.club),
                'Meal Preference': reg.meal_preference,
                'T-Shirt Size': reg.tshirt_size || 'N/A',
                'Amount': reg.registration_amount || 0,
                'Payment Status': reg.payment_status || 'pending',
                'Order ID': reg.order_id || 'N/A'
            }));
            
            // Create workbook
            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'All Registrations');
            
            // Auto-size columns
            const colWidths = [
                { wch: 12 }, // Registration ID
                { wch: 12 }, // Date
                { wch: 30 }, // Name
                { wch: 15 }, // Mobile
                { wch: 30 }, // Email
                { wch: 22 }, // Type
                { wch: 30 }, // Club
                { wch: 25 }, // Zone
                { wch: 15 }, // Meal
                { wch: 12 }, // T-Shirt
                { wch: 12 }, // Amount
                { wch: 15 }, // Status
                { wch: 30 }  // Order ID
            ];
            ws['!cols'] = colWidths;
            
            // Generate filename with timestamp
            const timestamp = new Date().toISOString().split('T')[0];
            const filename = `SNEHA-SAURABHA-All-Registrations-${timestamp}.xlsx`;
            
            // Download
            XLSX.writeFile(wb, filename);
            console.log('‚úÖ Excel exported:', filename);
        }
        
        function exportZoneWise(zoneName) {
            const zoneClubs = zoneMapping[zoneName];
            const zoneRegistrations = allRegistrations.filter(reg => 
                zoneClubs.includes(reg.club)
            );
            
            if (zoneRegistrations.length === 0) {
                alert(`No registrations found for ${zoneName}`);
                return;
            }
            
            // Prepare data for Excel
            const excelData = zoneRegistrations.map(reg => ({
                'Registration ID': reg.registration_id,
                'Date': new Date(reg.created_at).toLocaleDateString('en-IN'),
                'Name': reg.name,
                'Mobile': reg.mobile,
                'Email': reg.email || 'N/A',
                'Type': reg.registration_type,
                'Club': reg.club || 'N/A',
                'Meal Preference': reg.meal_preference,
                'T-Shirt Size': reg.tshirt_size || 'N/A',
                'Amount': reg.registration_amount || 0,
                'Payment Status': reg.payment_status || 'pending',
                'Order ID': reg.order_id || 'N/A'
            }));
            
            // Create workbook
            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, zoneName.substring(0, 30)); // Excel sheet name limit
            
            // Auto-size columns
            const colWidths = [
                { wch: 12 }, { wch: 12 }, { wch: 30 }, { wch: 15 },
                { wch: 30 }, { wch: 22 }, { wch: 30 }, { wch: 15 },
                { wch: 12 }, { wch: 12 }, { wch: 15 }, { wch: 30 }
            ];
            ws['!cols'] = colWidths;
            
            // Generate filename
            const timestamp = new Date().toISOString().split('T')[0];
            const zoneShort = zoneName.replace(/ /g, '-');
            const filename = `SNEHA-SAURABHA-${zoneShort}-${timestamp}.xlsx`;
            
            // Download
            XLSX.writeFile(wb, filename);
            console.log(`‚úÖ Zone export: ${zoneName} (${zoneRegistrations.length} registrations)`);
            alert(`Downloaded ${zoneRegistrations.length} registrations for ${zoneName}`);
        }
    </script>
</body>
</html>

```
    </script>
</body>
</html>
