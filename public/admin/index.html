<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - SNEHA SAURABHA 2025-26</title>
    <link rel="icon" href="data:,">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles/admin.css">
</head>
<body>
    <div id="login-screen" class="login-page">
        <div class="login-card">
            <h1>üéØ Admin Login</h1>
            <p>SNEHA SAURABHA 2025-26</p>
            <form id="login-form">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="username" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="password" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn-login">Login</button>
                <div id="error-msg" class="error"></div>
            </form>
        </div>
    </div>

    <div id="dashboard-screen" class="dashboard hidden">
        <div class="navbar">
            <div>
                <h2>üéØ SNEHA SAURABHA 2025-26</h2>
                <p style="color: #999; font-size: 13px; margin-top: 4px;">District Conference Registration Dashboard</p>
            </div>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
        
        <div class="content">
            <div class="stats">
                <div class="stat-card">
                    <h3 id="total">0</h3>
                    <p>Total Registrations</p>
                </div>
                <div class="stat-card">
                    <h3 id="revenue">‚Çπ0</h3>
                    <p>Total Revenue</p>
                </div>
                <div class="stat-card">
                    <h3 id="paid">0</h3>
                    <p>Confirmed Registrations</p>
                </div>
                <div class="stat-card">
                    <h3 id="manual">0</h3>
                    <p>Manual Entries</p>
                </div>
            </div>

            <div class="filters">
                <h4>üîç Sort By</h4>
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Registration Source</label>
                        <select id="filter-source" onchange="filterData()">
                            <option value="">All Sources</option>
                            <option value="Website">Website</option>
                            <option value="Manual">Manual Entry</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Registration Type</label>
                        <select id="filter-type" onchange="filterData()">
                            <option value="">All Types</option>
                            <option value="Rotarian">Rotarian</option>
                            <option value="Rotarian with Spouse">Rotarian with Spouse</option>
                            <option value="Ann">Ann</option>
                            <option value="Annet">Annet</option>
                            <option value="Innerwheel Member">Innerwheel Member</option>
                            <option value="Guest">Guest</option>
                            <option value="Rotaractor">Rotaractor</option>
                            <option value="Silver Donor">Silver Donor</option>
                            <option value="Silver Sponsor">Silver Sponsor</option>
                            <option value="Gold Sponsor">Gold Sponsor</option>
                            <option value="Platinum Sponsor">Platinum Sponsor</option>
                            <option value="Patron Sponsor">Patron Sponsor</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Meal Preference</label>
                        <select id="filter-meal" onchange="filterData()">
                            <option value="">All Meals</option>
                            <option value="Veg">Veg ü•ó</option>
                            <option value="Non-Veg">Non-Veg üçó</option>
                            <option value="Jain">Jain</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Club Name</label>
                        <select id="filter-club" onchange="filterData()">
                            <option value="">All Clubs</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="table-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0;">All Registrations</h3>
                    <button onclick="exportToExcel()" class="btn-export" style="padding: 10px 20px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        üì• Export to Excel
                    </button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Registration ID</th>
                            <th>Name</th>
                            <th>Mobile</th>
                            <th>Email</th>
                            <th>Club</th>
                            <th>Type</th>
                            <th>Meal</th>
                            <th>Amount</th>
                            <th>Payment Status</th>
                            <th>Transaction ID</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <tr><td colspan="11" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API = window.location.origin;
        let allRegistrations = []; // Store all data for filtering
        let allClubs = []; // Store clubs data

        // Load clubs data
        async function loadClubs() {
            try {
                const response = await fetch('/data/clubs.json');
                allClubs = await response.json();
                const clubSelect = document.getElementById('filter-club');
                allClubs.forEach(club => {
                    const option = document.createElement('option');
                    option.value = club.name;
                    option.textContent = club.name;
                    clubSelect.appendChild(option);
                });
                console.log('‚úÖ Loaded', allClubs.length, 'clubs');
            } catch (error) {
                console.error('Failed to load clubs:', error);
            }
        }

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            const err = document.getElementById('error-msg');
            err.style.display = 'none';

            try {
                const res = await fetch(API + '/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: user, password: pass })
                });
                const data = await res.json();
                
                if (data.success) {
                    sessionStorage.setItem('adminAuth', 'true');
                    sessionStorage.setItem('adminUser', user);
                    showDashboard();
                } else {
                    err.textContent = 'Invalid username or password';
                    err.style.display = 'block';
                }
            } catch (error) {
                console.error('Login error:', error);
                err.textContent = 'Login failed. Please try again.';
                err.style.display = 'block';
            }
        });

        function showDashboard() {
            console.log('üéØ Showing dashboard...');
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard-screen').classList.remove('hidden');
            console.log('‚úÖ Dashboard visible, loading data...');
            loadClubs(); // Load clubs for filter
            loadData();
        }

        function logout() {
            sessionStorage.removeItem('adminAuth');
            sessionStorage.removeItem('adminUser');
            document.getElementById('dashboard-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('error-msg').style.display = 'none';
        }

        async function loadData() {
            console.log('üìä Loading dashboard data...');
            try {
                console.log('Fetching stats from:', API + '/api/registrations/stats');
                const stats = await fetch(API + '/api/registrations/stats').then(r => r.json());
                console.log('Stats received:', stats);
                if (stats.success && stats.data) {
                    document.getElementById('total').textContent = stats.data.totalRegistrations || 0;
                    document.getElementById('revenue').textContent = '‚Çπ' + (stats.data.totalRevenue || 0).toLocaleString('en-IN');
                    document.getElementById('paid').textContent = stats.data.totalRegistrations || 0; // All are confirmed
                    // Count manual entries
                    const regsPreview = await fetch(API + '/api/registrations/list').then(r => r.json());
                    if (regsPreview.success && regsPreview.data && regsPreview.data.registrations) {
                        const manualCount = regsPreview.data.registrations.filter(r => r.registration_source === 'Manual').length;
                        document.getElementById('manual').textContent = manualCount;
                    }
                }

                const regs = await fetch(API + '/api/registrations/list').then(r => r.json());
                console.log('Registrations received:', regs);
                const tbody = document.getElementById('table-body');
                
                if (regs.success && regs.data && regs.data.registrations && regs.data.registrations.length > 0) {
                    allRegistrations = regs.data.registrations; // Store for filtering
                    renderTable(allRegistrations);
                } else {
                    tbody.innerHTML = '<tr><td colspan="11" class="loading">No registrations found</td></tr>';
                }
            } catch (error) {
                console.error('Load error:', error);
                document.getElementById('table-body').innerHTML = '<tr><td colspan="11" class="loading">Failed to load data</td></tr>';
            }
        }

        function renderTable(registrations) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = registrations.map(r => {
                const date = new Date(r.created_at);
                const formattedDate = date.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
                
                // All registrations are SUCCESS (by definition of being in registrations table)
                const source = r.registration_source || 'Website';
                const sourceDisplay = source === 'Manual' ? 'üë§ Manual' : 'üåê Website';
                
                return '<tr>' +
                    '<td><strong>' + (r.registration_id || 'N/A') + '</strong></td>' +
                    '<td>' + (r.name || 'N/A') + '</td>' +
                    '<td>' + (r.mobile || 'N/A') + '</td>' +
                    '<td style="font-size: 12px;">' + (r.email || 'Not Provided') + '</td>' +
                    '<td>' + (r.club || 'Not specified') + '</td>' +
                    '<td>' + (r.registration_type || 'N/A') + '</td>' +
                    '<td>' + (r.meal_preference || 'N/A') + '</td>' +
                    '<td><strong>‚Çπ' + (r.registration_amount || 0).toLocaleString('en-IN') + '</strong></td>' +
                    '<td><span class="badge badge-success">Success ‚úì</span></td>' +
                    '<td style="font-size: 11px;">' + (r.transaction_id || '-') + '</td>' +
                    '<td style="font-size: 12px;">' + formattedDate + '<br><small>' + sourceDisplay + '</small></td>' +
                '</tr>';
            }).join('');
            
            // Update counts after rendering
            updateTypeCounts();
        }

        function updateTypeCounts() {
            const typeCounts = {
                'Rotarian': 0,
                'Rotarian with Spouse': 0,
                'Ann': 0,
                'Annet': 0,
                'Innerwheel Member': 0,
                'Guest': 0,
                'Rotaractor': 0,
                'Silver Donor': 0,
                'Silver Sponsor': 0,
                'Gold Sponsor': 0,
                'Platinum Sponsor': 0,
                'Patron Sponsor': 0
            };

            allRegistrations.forEach(r => {
                const type = r.registration_type;
                if (typeCounts.hasOwnProperty(type)) {
                    typeCounts[type]++;
                }
            });

            // Update the select option text with counts
            const typeSelect = document.getElementById('filter-type');
            typeSelect.options[0].text = `All Types (${allRegistrations.length})`;
            typeSelect.options[1].text = `Rotarian (${typeCounts['Rotarian']})`;
            typeSelect.options[2].text = `Rotarian with Spouse (${typeCounts['Rotarian with Spouse']})`;
            typeSelect.options[3].text = `Ann (${typeCounts['Ann']})`;
            typeSelect.options[4].text = `Annet (${typeCounts['Annet']})`;
            typeSelect.options[5].text = `Innerwheel Member (${typeCounts['Innerwheel Member']})`;
            typeSelect.options[6].text = `Guest (${typeCounts['Guest']})`;
            typeSelect.options[7].text = `Rotaractor (${typeCounts['Rotaractor']})`;
            typeSelect.options[8].text = `Silver Donor (${typeCounts['Silver Donor']})`;
            typeSelect.options[9].text = `Silver Sponsor (${typeCounts['Silver Sponsor']})`;
            typeSelect.options[10].text = `Gold Sponsor (${typeCounts['Gold Sponsor']})`;
            typeSelect.options[11].text = `Platinum Sponsor (${typeCounts['Platinum Sponsor']})`;
            typeSelect.options[12].text = `Patron Sponsor (${typeCounts['Patron Sponsor']})`;
            
            // Also update other filters with counts
            updateAllFilterCounts();
        }

        function updateAllFilterCounts() {
            // Count registration sources
            const sourceCounts = { 'Website': 0, 'Manual': 0 };
            allRegistrations.forEach(r => {
                const source = r.registration_source || 'Website';
                sourceCounts[source]++;
            });
            
            const sourceSelect = document.getElementById('filter-source');
            sourceSelect.options[0].text = `All Sources (${allRegistrations.length})`;
            sourceSelect.options[1].text = `Website (${sourceCounts['Website']})`;
            sourceSelect.options[2].text = `Manual Entry (${sourceCounts['Manual']})`;
            
            // Count meal preferences
            const mealCounts = { 'Veg': 0, 'Non-Veg': 0, 'Jain': 0 };
            allRegistrations.forEach(r => {
                const meal = r.meal_preference;
                if (mealCounts.hasOwnProperty(meal)) {
                    mealCounts[meal]++;
                }
            });
            
            const mealSelect = document.getElementById('filter-meal');
            mealSelect.options[0].text = `All Meals (${allRegistrations.length})`;
            mealSelect.options[1].text = `Veg ü•ó (${mealCounts['Veg']})`;
            mealSelect.options[2].text = `Non-Veg üçó (${mealCounts['Non-Veg']})`;
            if (mealSelect.options[3]) {
                mealSelect.options[3].text = `Jain (${mealCounts['Jain']})`;
            }
        }

        function exportToExcel() {
            // Get current filtered data or all data
            const sourceFilter = document.getElementById('filter-source').value;
            const typeFilter = document.getElementById('filter-type').value;
            const mealFilter = document.getElementById('filter-meal').value;
            const clubFilter = document.getElementById('filter-club').value;

            let dataToExport = allRegistrations;

            // Apply same filters as the table
            if (sourceFilter) {
                dataToExport = dataToExport.filter(r => r.registration_source === sourceFilter);
            }
            if (typeFilter) {
                dataToExport = dataToExport.filter(r => r.registration_type === typeFilter);
            }
            if (mealFilter) {
                dataToExport = dataToExport.filter(r => r.meal_preference === mealFilter);
            }
            if (clubFilter) {
                dataToExport = dataToExport.filter(r => r.club === clubFilter);
            }

            // Create CSV content
            let csv = 'Registration ID,Name,Mobile,Email,Club,Type,Meal,Amount,Payment Status,Transaction ID,Date,Source\n';
            
            dataToExport.forEach(r => {
                const date = new Date(r.created_at).toLocaleDateString('en-IN');
                const source = r.registration_source || 'Website';
                csv += `"${r.registration_id || 'N/A'}","${r.name || 'N/A'}","${r.mobile || 'N/A'}","${r.email || 'Not Provided'}","${r.club || 'Not specified'}","${r.registration_type || 'N/A'}","${r.meal_preference || 'N/A'}","‚Çπ${(r.registration_amount || 0).toLocaleString('en-IN')}","SUCCESS","${r.transaction_id || '-'}","${date}","${source}"\n`;
            });

            // Create download link
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `registrations_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log(`üì• Exported ${dataToExport.length} registrations to Excel`);
        }

        function filterData() {
            const sourceFilter = document.getElementById('filter-source').value;
            const typeFilter = document.getElementById('filter-type').value;
            const mealFilter = document.getElementById('filter-meal').value;
            const clubFilter = document.getElementById('filter-club').value;

            let filtered = allRegistrations;

            // Filter by registration source (Website/Manual)
            if (sourceFilter) {
                filtered = filtered.filter(r => r.registration_source === sourceFilter);
            }

            // Filter by registration type
            if (typeFilter) {
                filtered = filtered.filter(r => r.registration_type === typeFilter);
            }

            // Filter by meal preference
            if (mealFilter) {
                filtered = filtered.filter(r => r.meal_preference === mealFilter);
            }

            // Filter by club
            if (clubFilter) {
                filtered = filtered.filter(r => r.club === clubFilter);
            }

            console.log(`üîç Filtered: ${filtered.length} of ${allRegistrations.length} registrations`);
            
            // Update table with filtered results
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = filtered.map(r => {
                const date = new Date(r.created_at);
                const formattedDate = date.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
                const source = r.registration_source || 'Website';
                const sourceDisplay = source === 'Manual' ? 'üë§ Manual' : 'üåê Website';
                
                return '<tr>' +
                    '<td><strong>' + (r.registration_id || 'N/A') + '</strong></td>' +
                    '<td>' + (r.name || 'N/A') + '</td>' +
                    '<td>' + (r.mobile || 'N/A') + '</td>' +
                    '<td style="font-size: 12px;">' + (r.email || 'Not Provided') + '</td>' +
                    '<td>' + (r.club || 'Not specified') + '</td>' +
                    '<td>' + (r.registration_type || 'N/A') + '</td>' +
                    '<td>' + (r.meal_preference || 'N/A') + '</td>' +
                    '<td><strong>‚Çπ' + (r.registration_amount || 0).toLocaleString('en-IN') + '</strong></td>' +
                    '<td><span class="badge badge-success">Success ‚úì</span></td>' +
                    '<td style="font-size: 11px;">' + (r.transaction_id || '-') + '</td>' +
                    '<td style="font-size: 12px;">' + formattedDate + '<br><small>' + sourceDisplay + '</small></td>' +
                '</tr>';
            }).join('');
        }

        if (sessionStorage.getItem('adminAuth') === 'true') {
            showDashboard();
        }
    </script>
</body>
</html>
